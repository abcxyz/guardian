# Copyright 2023 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Workflow for IAM drift detection
# Approach:
#   Run on schedule or manual
#   Execute drift script
#   If drift, create issue

name: 'guardian_detect_iam_drift'
description: |-
  Use this action to detect changes to your IAM settings in your GCP organization, folders, and projects.

inputs:
  organization_id:
    description: 'The ID of the GCP organization to detect IAM drift on.'
    required: true
  gcs_bucket_label:
    description: 'The label to use to discover GCS buckets used as terraform backends in your organization. Format "labels:{label}={value}"'
    default: 'labels:terraform'
    required: false
  issue_assignees:
    description: 'The assignees to use on the created github issue.'
    default: ''
    required: false
  issue_label:
    description: 'The label to use on the created github issue. This will be used to discover previously created issues and manage them.'
    default: 'guardian-iam-drift'
    required: false
  guardian_cli_version:
    description: 'The version of Guardian CLI.'
    default: 'latest'
    required: false
  go_version:
    description: 'The version of Golang.'
    default: '1.20'
    required: false

runs:
  using: 'composite'
  steps:
    - name: 'Setup Go'
      uses: 'actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568' # ratchet:actions/setup-go@v3
      with:
        go-version: '${{ inputs.go_version }}'

    - name: 'Install Guardian CLI'
      shell: 'bash'
      run: 'go install github.com/abcxyz/guardian/cmd/guardian@${{ inputs.guardian_cli_version }}'

    - name: 'Run diff'
      id: 'run_diff'
      shell: 'bash'
      env:
        ORGANIZATION_ID: '${{ inputs.organization_id }}'
        GCS_BUCKET_LABEL: '${{ inputs.gcs_bucket_label }}'
        GITHUB_TOKEN: '${{ github.token }}'
        GITHUB_OWNER: '${{ github.repository_owner }}'
        GITHUB_REPO: '${{ github.repository }}'
        ISSUE_ASSIGNEES: '${{ inputs.issue_assignees }}'
        ISSUE_LABEL: '${{ inputs.issue_label }}'
      run: |
        DRIFTIGNORE_FILE="$(pwd)/.driftignore"
        diff_snippet="$(guardian detect-iam-drift \
          -organization-id="$ORGANIZATION_ID" \
          -gcs-bucket-query="$GCS_BUCKET_LABEL" \
          -github-token="$GITHUB_TOKEN" \
          -github-owner="$GITHUB_OWNER" \
          -github-repo="$GITHUB_REPO" \
          -github-issue-assignees="$ISSUE_ASSIGNEES" \
          -github-issue-labels="$ISSUE_LABEL" \
          -driftignore-file="$DRIFTIGNORE_FILE")"

        # We output it so we can link the user to the full diff in the logs.
        echo "$diff_snippet"

